\documentclass[master]{finthesis}

\usepackage[pdftex]{graphicx}
\usepackage{amsmath}

\usepackage{caption}
\usepackage{subcaption}
\captionsetup[figure]{font=footnotesize, justification=centering}
%\captionsetup[table]{font=footnotesize}
\usepackage{tikz}
\usepackage{circuitikz}
%\usetikzlibrary{through, patterns}

%\usepackage[T1]{fontenc}

\usepackage[dvipsnames]{xcolor} % for more colors
\usepackage{amssymb} % for arrow symbol
\usepackage{tikz, pgfplots} % for diagram
\usepackage{schemabloc}  % for tikz trapezium
\usepackage{booktabs} % for bold lines in table
\usepackage{fancyhdr} % for header and footer

% For group PGF plots
\pgfplotsset{compat=newest}
\usetikzlibrary{pgfplots.groupplots}
\usepgfmodule{oo}

% Color variables
\def \CtrlColor        {darkgray}
\def \BBctrlColor      {RoyalBlue}
\def \PIDctrlColor     {OliveGreen}
\def \DCOColor         {BrickRed}
\def \CtrlDecColor     {brown}
\def \CtrlPreprocColor {RoyalPurple}
\def \ClkDivColor      {Goldenrod}
\def \RstnColor        {BurntOrange}

% Abbreviation variables
\def \PLL  {PLL} % phase-locked loop
\def \FLL  {FLL} % frequency-locked loop
\def \DLL  {DLL} % delay-locked loop
\def \DCO  {DCO} % digitally controlled oscillator 
\def \PID  {PID} % proportional-integral-derivative
\def \P    {P}   % proportional
\def \I    {I}   % integral
\def \D    {D}   % derivative
\def \FCW  {FCW} % frequency control word
\def \PWT  {PVT} % process-voltage-temperature
\def \HLLS {HLLS} % high-low level shifter
\def \LHLS {LHLS} % low-high level shifter


\addbibresource{master_rad.bib}

\title{Синтетизабилна дигитална фреквенцијски затворена петља са широким подешавањем до 640\texorpdfstring{\,}{ }MHz у 130\texorpdfstring{\,}{ }nm CMOS технологији}
\author{Ђорђе С. Гачић}
\studid{408/2022}
\advisor{проф. др Владимир М. Миловановић}
\advisorfull{Др Владимир М. Миловановић,\\ванредни професор}

\studprog{Електротехника и рачунарство}
% \module{Модул}
\course{Напредно машинско учење}
\date{\today}
% \date{ГГГГ-ММ-ДД}

\committee{др Шћепан Шћекић}
\committee{доц. др Жарко Попара}

\studentshould{% У оквиру овог рада кандидат треба да...
}

%\titlepagebib{greenwade93}
%\titlepagebib{pythonsite}
\titlepagebib{Staszewski:FREQUENCY_SYNTHESIZER_CMOS_2005}

\thesisapplicationfile{slike/prijava}

\abstracten{Frequency-locked loops (FLLs) represent a viable way of generating a range of frequencies from a single reference frequency by using a negative feedback electronic control system that compares the frequency of a controlled oscillator to the reference one. A digital synthesizable FLL is designed in 130\,nm CMOS technology for a target frequency of up to 640\,MHz. It employs a wide-tuning range digitally controlled oscillator (DCO) assembled from tri-state inverters in the form of a matrix. The FLL can optionally use a bang-bang or a soft-programmable standard proportional-integral-derivative (PID) controller to regulate the feedback loop. Its design practically minimizes metastability occurrence. The proposed digital FLL occupies 100\,\textmu m $\times$ 330\,\textmu m and consumes 3.5\,mW in typical operating conditions. The reference clock is 16\,MHz, and the output oscillation frequency is set to 640\,MHz, while the achieved frequency resolution is 2.8\,MHz.}
\keywordsen{Frequency-locked loop, digitally controlled oscillator, clock generator, synthesizable, CMOS technology, PID controller, metastability}

\abstractsr{Фреквенцијски затворене петље (енгл. \textsl{frequency-locked loops - FLLs}) представљају одржив начин генерисања опсега фреквенција из једне референтне фреквенције коришћењем електронског система управљања са негативном повратном спрегом, који пореди фреквенцију контролисаног осцилатора са поменутом референтном фреквенцијом. Дигитално синтетизабилан \FLL\ је дизајниран у 130\,nm технологији за циљану фреквенцију до 640\,MHz. Он погони дигитално контролисани осцилатор (енгл. \textsl{digitally-controlled oscillator - DCO}) са широким подешавањем опсега који се састоји од тростатаичких инвертора у облику матрице. \FLL\ може произвољно користити тзв. \textsl{bang-bang} контролер или дјелимично програмирани стандардни пропорционално-интегрално-диференцијални (енгл. \textsl{proportional-integral-derivative - PID}) контролер за управљање негативном петљом. Такав дизајн у пракси минимизује појаву метастабилности. Предложени дигитални \FLL\ заузима 100\,\textmu m $\times$ 330\,\textmu m простора и троши 3.5\,mW у уобичајеним условима рада. Референтни такт је 16\,MHz, а излазна фреквенција осциловања је подешена на 640\,MHz, док постигнута резолуција фреквенције износи 2.8\,MHz.}
\keywordssr{Фреквенцијски затворена петља, дигитално контролисани осцилатор, генератор такта, синтетизабилност, CMOS технологија, \PID\ контролер, метастабилност}

% Semantic markup. Look it up!
%\newcommand{\cmd}[2][]{\texttt{\textbackslash #2#1\{\ldots\}}} % Well, this one is useful beyond just semantics...
%\newcommand{\env}[1]{\texttt{#1}}
%\newcommand{\pkg}[1]{\texttt{#1}}
%\newcommand{\prog}[1]{\texttt{#1}}

\begin{document}

\maketitle

\tableofcontents

\makeabstract

\section{Увод}
У данашње вријеме, фазно затворена петља (енгл. \textsl{phase-locked loop - PLL)} и петља са затвореним кашњењем (енгл. \textsl{delay-locked loop - DLL}) представљају свеприсутне блокове у дизајну чипова. Безброј примјена самих чипова захтјевају или генератор такта или синтетизатор фреквенције, што подразумјева уградњу неког од поменутих блокова унутар система који се пројектује. Главна улога таквог блока у дизајну је да генерише стабилан и прецизан излазни сигнал чија је фаза подесива у односу на фазу улазног сигнала, самим тим одржавајући везу између улазне и излазне фреквенције. Међутим, чак и веома сложени системи често захтјевају генератор такта, који само множи улазну фреквенцију без да посебно води рачуна о фази такта или апсолутном подрхтавању (енгл. \textsl{jitter}). У таквим примјенама, потребна и довољна је само фреквенцијски затворена петља (енгл. \textsl{frequency-locked loop - FLL}) да би се испунили тражени захтјеви.

По дефиницији, \FLL\ је управљачки систем са негативном повратном спрегом који закључава фреквенцију излазног сигнала на предвиђену циљану фреквенцију. У принципу, непрастано управља фреквенцијом осцилатора на аутоматски начин све док излазна фреквенција на достигне циљану вриједност, након чега се та вриједност фреквенција одржава на излазу. Постоје многи начини имплементације \FLL-а~\cite{Ali:9097205}. Штавише, \FLL\ као интегрисано коло може спадати у двије групе: дигитални и аналогни \FLL. Иако је очигледан недостатак првих максимална фреквенција и њена резолуција, они посједују многе друге предности наспрам њихових аналогних супарника. Они заузимају мање простора, истичу се већом отпорношћу на промјене процесних углова, напона и температуре (енгл. \textsl{process-voltage-temperature - PVT}), лако су употребљиви у различитим технологијама, и стога омогућавају поновну употребу, већу прилагодљивост, једноставнију методологију тока пројектовања, као и брже циклусе пројектовања. Узимајући у обзир све претходно поменуто, испоставља се да је у општем случају боље ићи ка развоју дигиталног \FLL-a кад год спецификација архитектуре система то дозвољава. Дакле, фокус овог рада је пројектовати и унаприједити једноставне али моћне синтетизабилне дигиталне блокове чипа.

Овај рад конкретно предлаже синтетизабилан дигитални \FLL\ сличан предложеном у литератури~\cite{Musa:6644316}, са побољшаном брзином закључавања \FLL-а~\cite{Deng:6891375} и смањеним ризиком од метастабилности. Осцилатор је састављен од тростатичких инвертора и заснован на прстенастом \DCO-у из литературе~\cite{Tierno:4443210} измјењен додавањем независног напона напајања \DCO-а са претварачима напонских нивоа (енгл. \textsl{level shifters}) и употребом петостепене~\cite{Rylyakov:4523284} умјесто тростепене толологије прстена осцилатора.

Остатак рада укључује додатна поглавља. Поглавље \ref{FLL structure} описује предложени дигитални \FLL\ на системском нивоу и нивоу блокова и кола уз детаљна теоријска разматрања. Поглавље \ref{Implementation and results} пружа увид у имплементацију и добијене резултате симулација, такође уз теоријска разматрања појава које су од значаја за рад читавог система. Коначно, поглавље \ref{Conclusion} закључује рад и наговјештава могућности даљег рада на побољшању и проширењу система.


\section{Структура фреквенцијски затворене петље} \label{FLL structure}


У овом раду описана је релативно једноставна али ефикасна дигитална фреквенцијски затворена петља (\FLL). чију се системску архитектуру на нивоу блокова приказује \figurename~\ref{FLL block diagram}. Описани \FLL\ се практично састоји из два блока: дигитално контролисаног осцилатора (\DCO) и блока управљачке логике, који генерише улазне сигнале за \DCO\ на основу тренутне фреквенције \DCO-a. У сврху поједностављења, са слике су изостављени неки конфигурациони улази \FLL-a, као што су умножак фреквенције (енгл. \textsl{frequency control word - FCW}), коефицијенти \PID\ контролера и улаз за одабир режима рада. 

\input{slike/FLL.tex}

\subsection{Управљачка логика дигиталне фреквенцијски затворене петље}
Управљачка логика \FLL-a састоји се од двије независне процесне гране, које представљају два међусобно искључива режима управљања \FLL-a. Оба режима на улазу примају бинарну вриједност повезану са бројем периода такта \DCO-а унутар периода референтног такта. Такође, оба управљачка режима генеришу бинарну вриједност на излазу, која представља управљачку бинарну ријеч осцилатора директно пропорционалну излазној фреквенцији. Главне разлике између два поменута режима су брзина затварања (закључавања) \FLL-a и једноставност подешавања. Циљ управљачке логике \FLL-a је изједначити вриједност улазног множача фреквенције са бројем периода такта \DCO-a унутар периода референтног такта што је брже и прецизније могуће одрадити, чиме се долази до постизања жељене фреквенције на излазу \DCO-a. Комплетна управљачка логика \FLL-a је подјељена на неколико фаза, које су описане у наредним поглављима.

\subsubsection{Управљачка предобрада}
Фаза управљачке предобраде (енгл. \textsl{control preprocessing}) укључује неколико блокова чија је функција претворити информацију о фреквенцији излазног такта \DCO-a у бинарну вриједност која ће бити прослијеђена као улаз наредној фази управљачке логике \FLL-a. Као прво, да би се одредила брзина осциловања \DCO-a, потребан је бројач. У имплементацији описаној у овом раду коришћен је Грејев бројач умјесто природног бинарног бројача из разлога што значајно умањује метастабилност бројача изазвану узорковањем (енгл. \textsl{sampling}), јер у Грејевом коду свака узастопна вриједност се разликује за по један бит. Недостатак овог приступа је то што Грејев бројач има мању максималну радну фреквенцију од бинарног бројача. Да би се у још већем обиму смањио ризик од метастабилности, сваки бит са излаза Грејевог бројача се пропушта кроз синхронизатор са два флип-флопа да би безбједно прешао у подручје референтног такта. Затим, синхронизована вриједност Грејевог бројача се претвара у бинарни формат и узоркује се за даљу обраду.
% TODO
% Нешто више о Грејевом бројачу

\subsubsection{Bang-bang контролер}
Први управљачки блок \FLL-a је веома сличан bang-bang (или on-off) контролеру, односно контролеру са повратном спрегом који, као прекидач, може имати два стања. Он пореди улазни умножак фреквенције са узоркованом вриједношћу бројача и одлучује да ли инкрементирати, декрементирати или онемогућити предстојећи блок тј. двосмјерни бројач (енгл. \textsl{up-down counter}). То осигурава постепено управљање и закључавање све до постизања жељене фреквенције.

% TODO
% Нешто више о bang-bang контролеру

\subsubsection{\PID~контролер}
У другом управљачком режиму, управљачка бинарна ријеч за \DCO\ се генерише подесивим \PID\ контролером. \PID\ контролер је управљачки механизам заснован на повратној спрези, који ради тако што непрекидно исправља и скалира сигнал грешке, који је разлика између измјерене вриједности у обради (узоркована вриједност бројача) и жељене референтне задате вриједности (вриједност улазног умношка фреквенције). Исправљање и скалирање се распоређује у три компоненте: пропорционална (\P), интегрална (\I) и диференцијална (\D), имплементиране као подесиви улази са фиксном тачком који се напајају из банке регистара. \par
Сврха \P\ компоненте је да управља брзином одзива управљачког система, непосредно множећи сигнал грешке константним чиниоцем. \I\ компонента се користи за смањење грешке стабилног стања (енгл. \textsl{steady-state}) скалирањем грешке константним чиниоцем и сумирањем резултата током времена. \D\ компонента пропорционална брзини промјене грешке, и њен циљ је ограничити излаз да би се смањила могућа прекорачења или осцилације узроковане \P\ и \I\ компонентама, без смањења брзине контролера. Како је у овом систему референтна задата вриједност константна и нема брзих промјена на улазу које могу изазвати такав исход, \P\ и \I\ компоненте су довољне за гладак и стабилан одзив система.  

% TODO
% Нешто више о PID контролеру

\subsubsection{Управљачки декодер} \label{control decoder}
Улога управљачког декодера је претворити управљачке податке из једне бинарне вриједности у скуп управљачких улаза \DCO-а. Постоје три таква улаза: \textsl{Row On}, унарни вектор, који може да укључује читаве редове тростатичких инвертора \DCO-a; \textsl{Row Select}, један од $n$ вектор (енгл. \textsl{one-hot vector}), који укључује један додатни ред тростатичких инвертора \DCO-a; и \textsl{Column Select}, унарни вектор, који може да укључује колоне тростатичких инвертора \DCO-a. Да би се један инвертор укључио, или \textsl{Row On}, или и \textsl{Row Select} и \textsl{Column Select} за одговарајући бит морају бити подешени на 1. Ширина сваког вектора је једнака ширини улаза. Сама структура \DCO-a је детаљније описана у поглављу \ref{DCO structure}.

% TODO
% Нешто више о унарном и један од n кодирању

\subsection{Структура дигитално контролисаног осцилатора} \label{DCO structure}
У срцу сваке фазно затворене петље се налази осцилатор који игра кључну улогу у учинку који може бити постигнут~\cite{Razavi:PLL_CMOS_2020}. Дигитално контролисани осцилатор описан у овом раду је прстенасти осцилатор, погодан за систем генерисања такта. Прстенасти осцилатор је каскадна комбинација фаза кашњења повезаних у ланац затворене петље~\cite{Madhusudhana:283751064}. Прстенасте архитектуре су компактније од LC осцилатора и имају доста предности захваљујући својој правилној и периодичној просторној структури. Уопштена структура \DCO-а коришћеног унутар описаног \FLL-а заснована је на матрици тростатичких CMOS инвертора~\cite{Terosiet:340277809}. Ова матрица је састављена од $N$-фазних прстена тростатичких инвертора повезаних паралелно. $N$ представља број \DCO\ фаза (степени) и мора бити непаран број већи или једнак 3.
%(за осцилатор са једним излазним сигналом у односу на заједничко уземљење)
У физичком смислу, матрица може бити преобликована у квадрат, што омогућава једноставнију управљачку логику. Један или више прстенова су увијек укључени и дефинишу основну фреквенцију \DCO-а. Остали тростатички инвертори се укључују и искључују у зависности од управљачке логике. \par
Формула за фреквенцију осциловања конкретне имплементације \DCO-а из овог рада гласи:
\begin{equation} \label{f_osc}
    f_\text{osc} = \dfrac{1}{2Nt_\text{d}} \approx \dfrac{I_\text{d}}{2NC_\text{load}V_\text{DDL}}
\end{equation}
гдје је $N$ број тростатичких инвертора унутар прстена, $t_\text{d}$ представља кашњење једне ћелије \DCO-a, у чијем саставу је тростатички инвертор (у наставку ће бити детаљније објашњена структура саме ћелије \DCO-а), $I_\text{d}$ је струја која протиче кроз инвертор, $C_\text{load}$ је капацитивно оптерећење истог инвертора, и $V_\text{DDL}$ је напон напајања \DCO-а. Производ $Nt_\text{d}$ је помножен са $2$ да би се добила читава периода такта, а не полупериода.

\subsubsection{Предложена архитектура DCO-a}
Када је рijеч о топологији, са повећањем броја \DCO\ фаза (степени), фреквенцијски корак ($K_\text{DCO}$) опада, чиме се повећава прецизност \DCO-а. Максимална фреквенција осцилатора се се такође смањује, и да би се то надомјестило, напон напајања се може повећати, што с друге стране доводи до веће потрошње снаге. Ако претпоставимо да напон напајања и капацитивно оптерећење по једној фази остану непромјењени, повећање броја фаза не утиче на потрошњу снаге. Међутим, ако укупан број тростатичких инвертора остане непромјењен и подијели се на већи број фаза, то ће довести до смањења капацитивног оптерећења по фазама појединачно, што даље доводи до смањења потрошње снаге. Математичком анализом се то може објаснити на следећи начин: $N$-фазни прстенасти осцилатор који ради на фреквенцији $f_\text{osc}$ има динамичку потрошњу снаге која се може представити једначином
\begin{equation} \label{dynamic power}
    	P = N f_\text{osc} C_\text{tot} V^{2}_\text{DDL}, 
\end{equation}
гдје $C_\text{tot}$ представља укупно капацитивно оптерећење на једној фази. Пошто је фреквенција осциловања једнака
\begin{equation}
	f_\text{osc} = \frac{1}{2Nt_\text{d}},
\end{equation}
једначину за динамичку снагу можемо написати на следећи начин:
\begin{equation}
    	P = \frac{C_\text{tot}V^{2}_\text{DDL}}{2t_\text{d}},
\end{equation}
одакле се види да је добијена динамичка снага независна од $N$~\cite{Razavi:PLL_CMOS_2020}. \par

У овом раду описана је топологија \DCO-a са пет фаза, због тога што је таквом топологијом остварен задовољавајући компромис између учинка и потрошње снаге. \figurename~\ref{DCO5} приказује структуру \DCO-а коришћеног у описаној \FLL\ имплементацији. 
\input{slike/DCO.tex} \par
Свака фаза \DCO-а састоји се од 54 тростатичка инвертора, што ако помножимо са бројем фаза даје укупно 270 инвертора. Тростатички инвертори су распоређени у 18 редова и 15 колона. Управљачка логика \FLL-a управља са 17 редова и свих 15 колона, што значи да постоји 255 фреквенцијских корака. Преостали ред са 3$\times$5 тростатичких инвертора је увијек укључен и на њега не утиче управљачка логика \FLL-а. Што се више тростатичких инвертора у свакој фази укључи под утицајем управљачке логике \FLL-а, тренутна снага покретања (енгл. \textsl{driving strength}) једне фазе се повећава, док њено капацитивно оптерећење у суштини остаје константно, што резултује повећањем излазне фреквенције осциловања~\cite{Tierno:4443210}.

\subsubsection{Блок дијаграм DCO ћелије}
Да би се ефикасно подесила излазна фреквенција \DCO-а, уведен је скуп управљачких улаза \DCO-а, а то су сигнали \textsl{Row On}, \textsl{Row Select} и \textsl{Column Select}, поменути такође у секцији \ref{control decoder}. Према томе, сваки тростатички инвертор појединачно садржи сопствену управљачку јединицу у облику И-ИЛИ стандардне ћелије, и заједно граде већи блок назван ћелија \DCO-а. \figurename~\ref{DCO_cell} приказује шему ћелије \DCO-а на нивоу логичких кола и на нивоу CMOS транзистора.
\input{slike/DCO_cell.tex}

\subsubsection{Претварачи напонских нивоа DCO-a}
Напон напајања који користи дигитално контролисани осцилатор ($V_\text{DDL}$) се разликује од напона напајања који користи остатак логике \FLL-а ($V_\text{DD}$). Предност таквог дизајна је могућност подешавања напона напајања \DCO-а независно након производње чипа, што даље омогућава постизање жељене резолуције фреквенције (фреквенцијског корака) и фреквенцијског опсега зависно од процесног угла у коме се одвијала производња чипа. Додатна предност јесте и то што могућност смањења напона напајања \DCO-а аутоматски доводи и до значајног смањења расипања снаге (енгл. \textsl{power disipation}) због њене квадратне зависности од напона напајања.
Независан домен напајања \DCO-а постигнут је додавањем претварача напонских нивоа (енгл. \textsl{level shifters}) на улазе и излазе \DCO-а, као што је и приказано на Слици~\ref{DCO5}.
\input{slike/Level_shifters.tex}



\section{Имплементација и резултати симулација} \label{Implementation and results}

\subsection{Симулација рада фреквенцијски затворене петље}

\subsection{PVT зависност дигитално контролисаног осцилатора}

\subsection{Временски прорачун дигитално контролисаног осцилатора}

\subsection{Спектар снаге фреквенцијски затворене петље}

\subsection{Фазни шум дигитално контролисаног осцилатора}


\section{Закључак} \label{Conclusion}


\makebibliography

\end{document}
